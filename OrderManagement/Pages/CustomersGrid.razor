@page "/customers-grid"
@using OrderManagement.Data.Models
@using OrderManagement.Data
@using OrderManagement.Shared.Modals
@using MudBlazor.Services

@inject OrderManagementContext _context
@inject IDialogService DialogService

<PageTitle>Customers</PageTitle>
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-5">
    <MudDataGrid T="Customer" Items="@_customers" SortMode="SortMode.Multiple" Filterable="true" QuickFilter="@QuickFilter"
    Hideable="true" SelectedItems="_selectedCustomers" FooterClass="d-none" Striped ReadOnly="false" EditMode="DataGridEditMode.Cell" CommittedItemChanges="EditCustomer">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Customers</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
            AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium" Disabled="@_disableDelete" OnClick="RemovePlayers" />
            <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Medium" OnClick="OpenAddPlayerDialog" />
        </ToolBarContent>
        <Columns>
            <SelectColumn T="Customer" ShowInHeader="false" />
            <PropertyColumn Property="x => x.Id" Title="Id" IsEditable="false" />
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.Orders.Count()" Title="Orders Count" IsEditable="false" />
            <PropertyColumn Property="x => x.Email" Title="Email" />
            <PropertyColumn Property="x => x.Phone.ToString()" Title="Phone" />

        </Columns>
        <PagerContent>
            <MudDataGridPager T="Customer" />
        </PagerContent>
    </MudDataGrid>
</MudContainer>
@code {
    private string _searchString;

    private List<Customer> _customers = new List<Customer>();
    private HashSet<Customer> _selectedCustomers = new();

    private bool _disableDelete => _selectedCustomers.Count() == 0;

    protected override async Task OnInitializedAsync()
    {
        _customers = await _context.GetCustomersAsync();
    }

    // quick filter - filter globally across multiple columns with the same input
    private Func<Customer, bool> QuickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Email.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Phone.Contains(_searchString))
            return true;

        return false;
    };

    private async Task RemovePlayers()
    {
        _customers = _customers.Except(_selectedCustomers).ToList();
        await _context.RemoveCustomersAsync(_selectedCustomers);
        _selectedCustomers.Clear();
    }

    private async Task EditCustomer(Customer customer)
    {
        await _context.PostCustomerAsync(customer);
    }

    // modal

    private readonly DialogOptions _options = new() { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = true };
    private Task OpenAddPlayerDialog()
    {

        return DialogService.ShowAsync<AddCustomer>("Add Customer", _options);
    }
}
